<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>German Flashcards</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Learn German vocabulary with spaced repetition flashcards">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Flashcards">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16.png">
    <link rel="apple-touch-icon" href="icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --primary-subtle: #eef2ff;
            --accent: #ec4899;
            --accent-light: #f472b6;
            --success: #10b981;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            /* Handle iOS safe areas (notch, home indicator) */
            padding: 2rem 1.5rem;
            padding-top: max(2rem, env(safe-area-inset-top));
            padding-bottom: max(2rem, env(safe-area-inset-bottom));
            padding-left: max(1.5rem, env(safe-area-inset-left));
            padding-right: max(1.5rem, env(safe-area-inset-right));
            color: var(--gray-800);
            line-height: 1.6;
            /* Prevent overscroll bounce */
            overscroll-behavior: none;
            /* Smoother scrolling on iOS */
            -webkit-overflow-scrolling: touch;
        }

        /* Standalone mode (when installed as PWA) */
        @media all and (display-mode: standalone) {
            body {
                /* Slightly more padding when running as app */
                padding-top: max(2.5rem, env(safe-area-inset-top));
            }
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--gray-900);
            margin-bottom: 2.5rem;
            font-weight: 700;
            font-size: 1.875rem;
            letter-spacing: -0.025em;
        }

        h1::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            margin: 0.75rem auto 0;
            border-radius: 2px;
        }

        /* Study Status Banner */
        .study-status {
            background: linear-gradient(135deg, #fff 0%, var(--gray-50) 100%);
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .due-count {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .due-count.none {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .due-label {
            color: var(--gray-500);
            margin-bottom: 1.25rem;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .study-btn {
            padding: 0.875rem 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.4);
        }

        .study-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.5);
        }

        .study-btn:active {
            transform: translateY(0);
        }

        .study-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .exit-study-btn {
            padding: 0.625rem 1.25rem;
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 1.25rem;
            transition: all 0.2s ease;
        }

        .exit-study-btn:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        /* Card Sections */
        .add-form, .import-export, .card-list, .study-complete {
            background: white;
            padding: 1.75rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-100);
        }

        .add-form h2, .import-export h2, .card-list h2 {
            font-size: 0.8rem;
            color: var(--gray-400);
            margin-bottom: 1.25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .form-row input, .modal input {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--gray-50);
        }

        .form-row input:focus, .modal input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px var(--primary-subtle);
        }

        .form-row input::placeholder {
            color: var(--gray-400);
        }

        .add-form > button {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }

        .add-form > button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.4);
        }

        /* Flashcard */
        .flashcard-section {
            margin-bottom: 1.5rem;
        }

        .flashcard-container {
            perspective: 1500px;
            margin-bottom: 1.25rem;
            position: relative;
        }

        .flashcard {
            width: 100%;
            height: 220px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard.no-transition {
            transition: none !important;
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .flashcard-front {
            background: linear-gradient(135deg, #fff 0%, var(--gray-50) 100%);
            color: var(--gray-800);
            border: 1px solid var(--gray-200);
        }

        .flashcard-back {
            background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%);
            color: white;
            transform: rotateY(180deg);
            flex-direction: column;
            padding: 1.5rem;
        }

        .flashcard-back .example {
            font-size: 1rem;
            font-weight: 400;
            font-style: italic;
            opacity: 0.9;
            margin-top: 1rem;
            text-align: center;
            padding: 0 1rem;
            line-height: 1.5;
        }

        .card-counter {
            text-align: center;
            color: var(--gray-500);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        .nav-buttons button {
            padding: 0.75rem 1.75rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: inherit;
            color: var(--gray-700);
            transition: all 0.2s ease;
        }

        .nav-buttons button:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-subtle);
        }

        .nav-buttons button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Review Buttons */
        .review-buttons {
            display: none;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.25rem;
        }

        .review-buttons.visible {
            display: flex;
        }

        .review-btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .review-btn.wrong {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.4);
        }

        .review-btn.wrong:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(239, 68, 68, 0.5);
        }

        .review-btn.correct {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.4);
        }

        .review-btn.correct:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.5);
        }

        .review-btn.easy {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.4);
        }

        .review-btn.easy:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.5);
        }

        .scheduling-preview {
            display: none;
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
        }

        .scheduling-preview.visible {
            display: block;
        }

        .scheduling-preview .preview-title {
            font-size: 0.8rem;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .scheduling-preview .preview-options {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .scheduling-preview .preview-option {
            text-align: center;
        }

        .scheduling-preview .preview-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .scheduling-preview .preview-date {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .scheduling-preview .preview-option.wrong .preview-date {
            color: var(--danger);
        }

        .scheduling-preview .preview-option.correct .preview-date {
            color: var(--success);
        }

        .scheduling-preview .preview-option.easy .preview-date {
            color: var(--primary);
        }

        /* Settings Button */
        .settings-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--gray-100);
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .settings-btn svg {
            width: 18px;
            height: 18px;
        }

        .header-container {
            position: relative;
        }

        /* Settings Form */
        .settings-form .form-group {
            margin-bottom: 1.25rem;
        }

        .settings-form .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .settings-form .input-with-suffix {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-form input[type="number"] {
            width: 80px;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            text-align: center;
        }

        .settings-form input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-subtle);
        }

        .settings-form .input-suffix {
            color: var(--gray-500);
            font-size: 0.9rem;
        }

        .settings-form .color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .settings-form .color-indicator.wrong {
            background: var(--danger);
        }

        .settings-form .color-indicator.correct {
            background: var(--success);
        }

        .settings-form .color-indicator.easy {
            background: var(--primary);
        }

        /* Study Direction */
        .settings-form .direction-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .settings-form .direction-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .settings-form .direction-option:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        .settings-form .direction-option.selected {
            border-color: var(--primary);
            background: var(--primary-subtle);
        }

        .settings-form .direction-option input[type="radio"] {
            display: none;
        }

        .settings-form .direction-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .settings-form .direction-option.selected .direction-radio {
            border-color: var(--primary);
        }

        .settings-form .direction-option.selected .direction-radio::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
        }

        .settings-form .direction-label {
            flex: 1;
        }

        .settings-form .direction-label strong {
            display: block;
            color: var(--gray-800);
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .settings-form .direction-label span {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .settings-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 1.5rem 0;
        }

        .settings-section-title {
            font-size: 0.8rem;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        /* Direction Badge */
        .direction-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: var(--gray-100);
            border-radius: 50px;
            font-size: 0.75rem;
            color: var(--gray-600);
            font-weight: 500;
            margin-top: 0.75rem;
        }

        .direction-badge svg {
            width: 14px;
            height: 14px;
        }

        /* Study direction indicator in flashcard */
        .flashcard-direction {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            background: rgba(255,255,255,0.95);
            padding: 0.25rem 0.625rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 10;
            box-shadow: var(--shadow-sm);
        }

        .flip-hint {
            text-align: center;
            color: var(--gray-400);
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-400);
        }

        /* Card List */
        .card-list h2 {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-100);
            margin-bottom: 0;
        }

        .card-list ul {
            list-style: none;
        }

        .card-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.2s ease;
        }

        .card-list li:last-child {
            border-bottom: none;
            padding-bottom: 0.5rem;
        }

        .card-list li:first-child {
            padding-top: 1rem;
        }

        .card-info {
            flex: 1;
        }

        .card-text {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.375rem;
            flex-wrap: wrap;
        }

        .card-text .german {
            font-weight: 600;
            color: var(--gray-800);
        }

        .card-text .english {
            color: var(--gray-500);
        }

        .card-example {
            font-size: 0.85rem;
            color: var(--gray-400);
            font-style: italic;
            margin-top: 0.375rem;
        }

        .card-meta {
            font-size: 0.8rem;
            color: var(--gray-400);
            margin-top: 0.375rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .card-meta .due {
            color: var(--danger);
            font-weight: 500;
        }

        .card-meta .due-today {
            color: var(--primary);
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 0.625rem;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .edit-btn {
            color: var(--gray-400);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .edit-btn:hover {
            color: var(--primary);
            background: var(--primary-subtle);
        }

        .delete-btn {
            color: var(--gray-400);
            font-size: 1.25rem;
        }

        .delete-btn:hover {
            color: var(--danger);
            background: var(--danger-light);
        }

        .card-list .empty-state {
            padding: 2rem 0;
        }

        /* Import/Export Section */
        .import-export-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .import-export-buttons button {
            flex: 1;
            padding: 0.875rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--gray-600);
        }

        .import-export-buttons button:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-subtle);
        }

        .file-input-wrapper {
            flex: 1;
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-wrapper .file-btn {
            width: 100%;
            padding: 0.875rem;
            border: 2px dashed var(--primary-light);
            background: var(--primary-subtle);
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--primary);
            text-align: center;
            transition: all 0.2s ease;
        }

        .file-input-wrapper:hover .file-btn {
            background: #e0e7ff;
            border-color: var(--primary);
        }

        .import-result {
            margin-top: 1rem;
            padding: 0.875rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .import-result.success {
            background: var(--success-light);
            color: #065f46;
        }

        .import-result.error {
            background: var(--danger-light);
            color: #991b1b;
        }

        /* Study Complete */
        .study-complete {
            padding: 3rem 2rem;
            text-align: center;
        }

        .study-complete h2 {
            color: var(--success);
            margin-bottom: 0.75rem;
            font-size: 1.5rem;
            text-transform: none;
            letter-spacing: normal;
        }

        .study-complete p {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }

        /* Flashcard Edit Button */
        .flashcard-edit-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(255,255,255,0.95);
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: var(--shadow-sm);
        }

        .flashcard-edit-btn:hover {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow);
        }

        /* Edit Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 480px;
            box-shadow: var(--shadow-xl);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal h2 {
            font-size: 1.25rem;
            color: var(--gray-800);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .modal .form-group {
            margin-bottom: 1rem;
        }

        .modal label {
            display: block;
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.75rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 0.875rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-buttons .cancel-btn {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .modal-buttons .cancel-btn:hover {
            background: var(--gray-200);
        }

        .modal-buttons .save-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.3);
        }

        .modal-buttons .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.4);
        }

        /* Scan Word Feature */
        .scan-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.3);
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .scan-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.4);
        }

        .scan-btn svg {
            width: 20px;
            height: 20px;
        }

        .scan-modal .modal {
            max-width: 560px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            background: var(--gray-900);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .camera-container video {
            width: 100%;
            display: block;
        }

        .camera-container canvas {
            display: none;
        }

        .captured-image {
            width: 100%;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }

        .scan-status {
            text-align: center;
            padding: 1rem;
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        .scan-status.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .scan-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .scan-result {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-200);
        }

        .scan-result-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .scan-result-row:last-child {
            margin-bottom: 0;
        }

        .scan-result-label {
            font-size: 0.8rem;
            color: var(--gray-500);
            font-weight: 500;
            min-width: 70px;
        }

        .scan-result-value {
            flex: 1;
            font-size: 1rem;
            color: var(--gray-800);
            font-weight: 600;
        }

        .scan-result-value.editable {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            background: white;
            font-family: inherit;
        }

        .scan-result-value.editable:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-subtle);
        }

        .camera-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .capture-btn {
            flex: 1;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .capture-btn:hover {
            transform: translateY(-1px);
        }

        .capture-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
        }

        .capture-btn svg {
            width: 20px;
            height: 20px;
        }

        .retake-btn {
            padding: 0.875rem 1.25rem;
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .retake-btn:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .scan-error {
            background: var(--danger-light);
            color: #991b1b;
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .scan-progress {
            margin-top: 0.5rem;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .form-row {
                flex-direction: column;
            }

            .flashcard {
                height: 180px;
            }

            .flashcard-face {
                font-size: 1.5rem;
            }

            .review-buttons {
                flex-direction: column;
            }

            .review-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>German Flashcards</h1>
            <button class="settings-btn" onclick="openSettingsModal()" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>

        <!-- Study Status Banner -->
        <div class="study-status" id="studyStatus">
            <div class="due-count" id="dueCount">0</div>
            <div class="due-label">cards due for review</div>
            <button class="study-btn" id="studyBtn" onclick="startStudyMode()">Study Now</button>
            <div class="direction-badge" id="directionBadge">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                <span id="directionBadgeText">DE → EN</span>
            </div>
        </div>

        <!-- Add Card Form -->
        <div class="add-form" id="addForm">
            <h2>Add New Card</h2>
            <div class="form-row">
                <input type="text" id="germanInput" placeholder="German word">
                <input type="text" id="englishInput" placeholder="English translation">
            </div>
            <div class="form-row">
                <input type="text" id="exampleInput" placeholder="Example sentence (optional)">
            </div>
            <button onclick="addCard()">Add Card</button>
            <button class="scan-btn" onclick="openScanModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Scan Word with Camera
            </button>
        </div>

        <!-- Import/Export Section -->
        <div class="import-export" id="importExportSection">
            <h2>Import / Export</h2>
            <div class="import-export-buttons">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFileInput" accept=".csv" onchange="importCSV(event)">
                    <div class="file-btn">Import CSV</div>
                </div>
                <button onclick="exportCSV()">Export CSV</button>
            </div>
            <div class="import-result" id="importResult" style="display: none;"></div>
        </div>

        <!-- Study Complete Message -->
        <div class="study-complete" id="studyComplete" style="display: none;">
            <h2>All Done!</h2>
            <p>You've reviewed all due cards for now.</p>
            <button class="study-btn" onclick="exitStudyMode()">Back to Home</button>
        </div>

        <!-- Flashcard Section -->
        <div class="flashcard-section" id="flashcardSection" style="display: none;">
            <button class="exit-study-btn" id="exitStudyBtn" onclick="exitStudyMode()" style="display: none;">Exit Study Mode</button>
            <div class="flashcard-container">
                <div class="flashcard-direction" id="flashcardDirection">DE → EN</div>
                <button class="flashcard-edit-btn" onclick="editCurrentCard(event)">Edit</button>
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-face flashcard-front">
                        <span id="frontWord"></span>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <span id="backWord"></span>
                        <div class="example" id="exampleSentence"></div>
                    </div>
                </div>
            </div>
            <div class="card-counter" id="cardCounter"></div>
            <div class="flip-hint" id="flipHint">Click card to reveal answer</div>

            <!-- Review Buttons (shown after flip in study mode) -->
            <div class="review-buttons" id="reviewButtons">
                <button class="review-btn wrong" onclick="markWrong()">Wrong</button>
                <button class="review-btn correct" onclick="markCorrect()">Correct</button>
                <button class="review-btn easy" onclick="markEasy()">Easy</button>
            </div>

            <!-- Scheduling Preview -->
            <div class="scheduling-preview" id="schedulingPreview">
                <div class="preview-title">Next review</div>
                <div class="preview-options">
                    <div class="preview-option wrong">
                        <div class="preview-label">Wrong</div>
                        <div class="preview-date" id="previewWrong"></div>
                    </div>
                    <div class="preview-option correct">
                        <div class="preview-label">Correct</div>
                        <div class="preview-date" id="previewCorrect"></div>
                    </div>
                    <div class="preview-option easy">
                        <div class="preview-label">Easy</div>
                        <div class="preview-date" id="previewEasy"></div>
                    </div>
                </div>
            </div>

            <!-- Nav Buttons (shown in browse mode) -->
            <div class="nav-buttons" id="navButtons">
                <button onclick="prevCard()" id="prevBtn">Previous</button>
                <button onclick="nextCard()" id="nextBtn">Next</button>
            </div>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <p>No flashcards yet. Add your first card above!</p>
        </div>

        <!-- Card List -->
        <div class="card-list" id="cardListSection">
            <h2>All Cards</h2>
            <ul id="cardList">
                <li class="empty-state">No cards added yet</li>
            </ul>
        </div>

        <!-- Edit Modal -->
        <div class="modal-overlay" id="editModal">
            <div class="modal">
                <h2>Edit Card</h2>
                <div class="form-group">
                    <label for="editGermanInput">German</label>
                    <input type="text" id="editGermanInput">
                </div>
                <div class="form-group">
                    <label for="editEnglishInput">English</label>
                    <input type="text" id="editEnglishInput">
                </div>
                <div class="form-group">
                    <label for="editExampleInput">Example sentence</label>
                    <input type="text" id="editExampleInput">
                </div>
                <div class="modal-buttons">
                    <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                    <button class="save-btn" onclick="saveEdit()">Save</button>
                </div>
            </div>
        </div>

        <!-- Scan Word Modal -->
        <div class="modal-overlay scan-modal" id="scanModal">
            <div class="modal">
                <h2>Scan German Word</h2>

                <!-- Camera View -->
                <div id="cameraView">
                    <div class="camera-container">
                        <video id="scanVideo" autoplay playsinline></video>
                        <canvas id="scanCanvas"></canvas>
                    </div>
                    <div class="camera-buttons">
                        <button class="capture-btn" onclick="captureImage()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Capture
                        </button>
                    </div>
                </div>

                <!-- Processing View -->
                <div id="processingView" style="display: none;">
                    <img id="capturedImage" class="captured-image" alt="Captured image">
                    <div class="scan-status loading" id="scanStatus">
                        <div class="scan-spinner"></div>
                        <span id="scanStatusText">Recognizing text...</span>
                    </div>
                    <div class="scan-progress" id="scanProgress" style="display: none;">
                        <div class="scan-progress-bar" id="scanProgressBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Error View -->
                <div id="errorView" style="display: none;">
                    <div class="scan-error" id="scanError"></div>
                    <button class="retake-btn" onclick="retakeScan()" style="width: 100%;">Try Again</button>
                </div>

                <!-- Result View -->
                <div id="resultView" style="display: none;">
                    <img id="resultImage" class="captured-image" alt="Captured image">
                    <div class="scan-result">
                        <div class="scan-result-row">
                            <span class="scan-result-label">German:</span>
                            <input type="text" class="scan-result-value editable" id="scannedGerman">
                        </div>
                        <div class="scan-result-row">
                            <span class="scan-result-label">English:</span>
                            <input type="text" class="scan-result-value editable" id="scannedEnglish">
                        </div>
                    </div>
                    <div class="camera-buttons">
                        <button class="retake-btn" onclick="retakeScan()">Retake</button>
                        <button class="capture-btn" onclick="saveScannedCard()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                            Save Card
                        </button>
                    </div>
                </div>

                <div class="modal-buttons" style="margin-top: 1rem;">
                    <button class="cancel-btn" onclick="closeScanModal()" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal-overlay" id="settingsModal">
            <div class="modal">
                <h2>Settings</h2>
                <div class="settings-form">
                    <div class="settings-section-title">Study Direction</div>
                    <div class="direction-options" id="directionOptions">
                        <label class="direction-option selected" data-direction="de-en">
                            <input type="radio" name="studyDirection" value="de-en" checked>
                            <div class="direction-radio"></div>
                            <div class="direction-label">
                                <strong>German → English</strong>
                                <span>See German word, reveal English translation</span>
                            </div>
                        </label>
                        <label class="direction-option" data-direction="en-de">
                            <input type="radio" name="studyDirection" value="en-de">
                            <div class="direction-radio"></div>
                            <div class="direction-label">
                                <strong>English → German</strong>
                                <span>See English word, reveal German translation</span>
                            </div>
                        </label>
                        <label class="direction-option" data-direction="mixed">
                            <input type="radio" name="studyDirection" value="mixed">
                            <div class="direction-radio"></div>
                            <div class="direction-label">
                                <strong>Mixed / Both</strong>
                                <span>Random mix of both directions</span>
                            </div>
                        </label>
                    </div>

                    <div class="settings-divider"></div>
                    <div class="settings-section-title">Review Intervals</div>

                    <div class="form-group">
                        <label>
                            <span class="color-indicator wrong"></span>
                            Wrong - review again in
                        </label>
                        <div class="input-with-suffix">
                            <input type="number" id="intervalWrong" min="1" max="365" value="1">
                            <span class="input-suffix">day(s)</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <span class="color-indicator correct"></span>
                            Correct - review again in
                        </label>
                        <div class="input-with-suffix">
                            <input type="number" id="intervalCorrect" min="1" max="365" value="3">
                            <span class="input-suffix">day(s)</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <span class="color-indicator easy"></span>
                            Easy - review again in
                        </label>
                        <div class="input-with-suffix">
                            <input type="number" id="intervalEasy" min="1" max="365" value="14">
                            <span class="input-suffix">day(s)</span>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="cancel-btn" onclick="closeSettingsModal()">Cancel</button>
                    <button class="save-btn" onclick="saveSettings()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cards = [];
        let currentIndex = 0;
        let studyMode = false;
        let studyQueue = [];
        let studyIndex = 0;

        // Default settings for spaced repetition intervals
        const DEFAULT_SETTINGS = {
            intervalWrong: 1,
            intervalCorrect: 3,
            intervalEasy: 14,
            studyDirection: 'de-en' // 'de-en', 'en-de', or 'mixed'
        };

        let settings = { ...DEFAULT_SETTINGS };
        let currentCardDirection = 'de-en'; // Track direction for current card in mixed mode

        // Load settings from localStorage
        function loadSettings() {
            const stored = localStorage.getItem('germanFlashcardsSettings');
            if (stored) {
                settings = { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
            }
        }

        // Save settings to localStorage
        function saveSettingsToStorage() {
            localStorage.setItem('germanFlashcardsSettings', JSON.stringify(settings));
        }

        // Get today's date at midnight for comparison
        function getToday() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        }

        // Add days to a timestamp
        function addDays(timestamp, days) {
            return timestamp + (days * 24 * 60 * 60 * 1000);
        }

        // Check if a card is due for review
        function isDue(card) {
            if (!card.nextReview) return true;
            return card.nextReview <= getToday();
        }

        // Get cards due for review
        function getDueCards() {
            return cards.filter(isDue);
        }

        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp) return 'New';
            const today = getToday();
            const tomorrow = addDays(today, 1);

            if (timestamp <= today) return 'Due now';
            if (timestamp <= tomorrow) return 'Tomorrow';

            const daysUntil = Math.ceil((timestamp - today) / (24 * 60 * 60 * 1000));
            if (daysUntil <= 7) return `In ${daysUntil} days`;

            // Show actual date for longer intervals
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Format interval for preview display
        function formatInterval(days) {
            if (days === 1) return 'Tomorrow';
            if (days < 7) return `In ${days} days`;
            if (days === 7) return 'In 1 week';
            if (days === 14) return 'In 2 weeks';
            if (days < 30) return `In ${days} days`;
            if (days === 30) return 'In 1 month';
            return `In ${days} days`;
        }

        // Load cards from localStorage
        function loadCards() {
            const stored = localStorage.getItem('germanFlashcards');
            if (stored) {
                cards = JSON.parse(stored);
                // Migrate old cards without SRS data or example
                cards = cards.map(card => ({
                    ...card,
                    level: card.level || 0,
                    nextReview: card.nextReview || null,
                    lastReview: card.lastReview || null,
                    example: card.example || ''
                }));
            }
            updateDisplay();
        }

        // Save cards to localStorage
        function saveCards() {
            localStorage.setItem('germanFlashcards', JSON.stringify(cards));
        }

        // Add a new card
        function addCard() {
            const germanInput = document.getElementById('germanInput');
            const englishInput = document.getElementById('englishInput');
            const exampleInput = document.getElementById('exampleInput');

            const german = germanInput.value.trim();
            const english = englishInput.value.trim();
            const example = exampleInput.value.trim();

            if (!german || !english) {
                alert('Please enter both German and English words');
                return;
            }

            cards.push({
                german,
                english,
                example,
                level: 0,
                nextReview: null,
                lastReview: null
            });
            saveCards();

            germanInput.value = '';
            englishInput.value = '';
            exampleInput.value = '';

            currentIndex = cards.length - 1;
            updateDisplay();
        }

        // Delete a card
        function deleteCard(index) {
            cards.splice(index, 1);
            saveCards();

            if (currentIndex >= cards.length) {
                currentIndex = Math.max(0, cards.length - 1);
            }
            updateDisplay();
        }

        // Start study mode
        function startStudyMode() {
            studyQueue = getDueCards();
            if (studyQueue.length === 0) return;

            studyMode = true;
            studyIndex = 0;

            document.getElementById('addForm').style.display = 'none';
            document.getElementById('importExportSection').style.display = 'none';
            document.getElementById('studyStatus').style.display = 'none';
            document.getElementById('cardListSection').style.display = 'none';
            document.getElementById('exitStudyBtn').style.display = 'block';
            document.getElementById('navButtons').style.display = 'none';
            document.getElementById('studyComplete').style.display = 'none';

            updateStudyCard();
        }

        // Exit study mode
        function exitStudyMode() {
            studyMode = false;
            studyQueue = [];

            document.getElementById('addForm').style.display = 'block';
            document.getElementById('importExportSection').style.display = 'block';
            document.getElementById('studyStatus').style.display = 'block';
            document.getElementById('cardListSection').style.display = 'block';
            document.getElementById('exitStudyBtn').style.display = 'none';
            document.getElementById('navButtons').style.display = 'flex';
            document.getElementById('studyComplete').style.display = 'none';

            updateDisplay();
        }

        // Get direction label for display
        function getDirectionLabel(direction) {
            switch (direction) {
                case 'de-en': return 'DE → EN';
                case 'en-de': return 'EN → DE';
                case 'mixed': return 'Mixed';
                default: return 'DE → EN';
            }
        }

        // Get current direction for a card (handles mixed mode)
        function getCardDirection() {
            if (settings.studyDirection === 'mixed') {
                return Math.random() < 0.5 ? 'de-en' : 'en-de';
            }
            return settings.studyDirection;
        }

        // Update study card display
        function updateStudyCard() {
            if (studyIndex >= studyQueue.length) {
                // Study session complete
                document.getElementById('flashcardSection').style.display = 'none';
                document.getElementById('studyComplete').style.display = 'block';
                return;
            }

            document.getElementById('flashcardSection').style.display = 'block';
            document.getElementById('studyComplete').style.display = 'none';

            const flashcard = document.getElementById('flashcard');

            // Disable transitions first to prevent any animation
            flashcard.classList.add('no-transition');
            // Reset to un-flipped state (show front/question)
            flashcard.classList.remove('flipped');

            const card = studyQueue[studyIndex];

            // Determine direction for this card
            currentCardDirection = getCardDirection();

            // Set front and back based on direction
            if (currentCardDirection === 'en-de') {
                document.getElementById('frontWord').textContent = card.english;
                document.getElementById('backWord').textContent = card.german;
                document.getElementById('flashcardDirection').textContent = 'EN → DE';
            } else {
                document.getElementById('frontWord').textContent = card.german;
                document.getElementById('backWord').textContent = card.english;
                document.getElementById('flashcardDirection').textContent = 'DE → EN';
            }

            document.getElementById('exampleSentence').textContent = card.example || '';
            document.getElementById('cardCounter').textContent =
                `${studyIndex + 1} / ${studyQueue.length}`;

            // Update scheduling preview
            document.getElementById('previewWrong').textContent = formatInterval(settings.intervalWrong);
            document.getElementById('previewCorrect').textContent = formatInterval(settings.intervalCorrect);
            document.getElementById('previewEasy').textContent = formatInterval(settings.intervalEasy);

            // Force a synchronous reflow to ensure the un-flipped state and new content
            // are applied before the browser paints
            void flashcard.offsetWidth;

            // Use double requestAnimationFrame to ensure the browser has fully painted
            // the un-flipped state before re-enabling transitions. A single RAF isn't
            // enough as styles may not be committed yet.
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    flashcard.classList.remove('no-transition');
                });
            });

            document.getElementById('reviewButtons').classList.remove('visible');
            document.getElementById('schedulingPreview').classList.remove('visible');
            document.getElementById('flipHint').style.display = 'block';
        }

        // Mark card as wrong
        function markWrong() {
            const card = studyQueue[studyIndex];
            const cardIndex = cards.findIndex(c => c.german === card.german && c.english === card.english);

            if (cardIndex !== -1) {
                cards[cardIndex].level = 0;
                cards[cardIndex].nextReview = addDays(getToday(), settings.intervalWrong);
                cards[cardIndex].lastReview = Date.now();
                cards[cardIndex].lastResponse = 'wrong';
                saveCards();
            }

            nextStudyCard();
        }

        // Mark card as correct
        function markCorrect() {
            const card = studyQueue[studyIndex];
            const cardIndex = cards.findIndex(c => c.german === card.german && c.english === card.english);

            if (cardIndex !== -1) {
                cards[cardIndex].level = Math.min((cards[cardIndex].level || 0) + 1, 10);
                cards[cardIndex].nextReview = addDays(getToday(), settings.intervalCorrect);
                cards[cardIndex].lastReview = Date.now();
                cards[cardIndex].lastResponse = 'correct';
                saveCards();
            }

            nextStudyCard();
        }

        // Mark card as easy
        function markEasy() {
            const card = studyQueue[studyIndex];
            const cardIndex = cards.findIndex(c => c.german === card.german && c.english === card.english);

            if (cardIndex !== -1) {
                cards[cardIndex].level = Math.min((cards[cardIndex].level || 0) + 2, 10);
                cards[cardIndex].nextReview = addDays(getToday(), settings.intervalEasy);
                cards[cardIndex].lastReview = Date.now();
                cards[cardIndex].lastResponse = 'easy';
                saveCards();
            }

            nextStudyCard();
        }

        // Move to next study card
        function nextStudyCard() {
            studyIndex++;
            updateStudyCard();
        }

        // Flip the flashcard
        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');

            if (studyMode && flashcard.classList.contains('flipped')) {
                document.getElementById('reviewButtons').classList.add('visible');
                document.getElementById('schedulingPreview').classList.add('visible');
                document.getElementById('flipHint').style.display = 'none';
            }
        }

        // Navigate to previous card
        function prevCard() {
            if (currentIndex > 0) {
                currentIndex--;
                resetFlipAndUpdate();
            }
        }

        // Navigate to next card
        function nextCard() {
            if (currentIndex < cards.length - 1) {
                currentIndex++;
                resetFlipAndUpdate();
            }
        }

        // Reset flip state instantly (no animation) and update card content
        function resetFlipAndUpdate() {
            const flashcard = document.getElementById('flashcard');

            // Disable transitions to prevent animation
            flashcard.classList.add('no-transition');
            // Reset to un-flipped state (show front/question)
            flashcard.classList.remove('flipped');

            // Update the card content
            updateFlashcard();

            // Force synchronous reflow
            void flashcard.offsetWidth;

            // Use double RAF to ensure browser has painted before re-enabling transitions
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    flashcard.classList.remove('no-transition');
                });
            });
        }

        // Reset flip state (legacy, kept for compatibility)
        function resetFlip() {
            document.getElementById('flashcard').classList.remove('flipped');
        }

        // Update the flashcard display (browse mode - always DE → EN)
        function updateFlashcard() {
            if (cards.length === 0) return;

            const card = cards[currentIndex];

            // In browse mode, use the current setting direction
            const direction = settings.studyDirection === 'mixed' ? 'de-en' : settings.studyDirection;

            if (direction === 'en-de') {
                document.getElementById('frontWord').textContent = card.english;
                document.getElementById('backWord').textContent = card.german;
                document.getElementById('flashcardDirection').textContent = 'EN → DE';
            } else {
                document.getElementById('frontWord').textContent = card.german;
                document.getElementById('backWord').textContent = card.english;
                document.getElementById('flashcardDirection').textContent = 'DE → EN';
            }

            document.getElementById('exampleSentence').textContent = card.example || '';
            document.getElementById('cardCounter').textContent =
                `${currentIndex + 1} / ${cards.length}`;

            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === cards.length - 1;
        }

        // Update the card list
        function updateCardList() {
            const list = document.getElementById('cardList');

            if (cards.length === 0) {
                list.innerHTML = '<li class="empty-state">No cards added yet</li>';
                return;
            }

            const today = getToday();

            list.innerHTML = cards.map((card, index) => {
                const dueStatus = formatDate(card.nextReview);
                const isDueNow = !card.nextReview || card.nextReview <= today;
                const isDueToday = card.nextReview && card.nextReview <= addDays(today, 1);

                let statusClass = '';
                if (isDueNow) statusClass = 'due';
                else if (isDueToday) statusClass = 'due-today';

                // Format next review date
                let nextReviewText = '';
                if (card.nextReview) {
                    const nextDate = new Date(card.nextReview);
                    nextReviewText = nextDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: nextDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                    });
                }

                return `
                    <li>
                        <div class="card-info">
                            <div class="card-text">
                                <span class="german">${escapeHtml(card.german)}</span>
                                <span class="english">${escapeHtml(card.english)}</span>
                            </div>
                            ${card.example ? `<div class="card-example">${escapeHtml(card.example)}</div>` : ''}
                            <div class="card-meta">
                                <span class="${statusClass}">${dueStatus}</span>
                                ${nextReviewText && !isDueNow ? ` · ${nextReviewText}` : ''}
                                ${card.level > 0 ? ` · Level ${card.level}` : ''}
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="edit-btn" onclick="openEditModal(${index})">Edit</button>
                            <button class="delete-btn" onclick="deleteCard(${index})">×</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Update study status banner
        function updateStudyStatus() {
            const dueCards = getDueCards();
            const dueCount = document.getElementById('dueCount');
            const studyBtn = document.getElementById('studyBtn');

            dueCount.textContent = dueCards.length;
            dueCount.classList.toggle('none', dueCards.length === 0);
            studyBtn.disabled = dueCards.length === 0;

            if (dueCards.length === 0) {
                studyBtn.textContent = 'All caught up!';
            } else {
                studyBtn.textContent = 'Study Now';
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Edit modal state
        let editingIndex = -1;

        // Open edit modal
        function openEditModal(index) {
            editingIndex = index;
            const card = cards[index];

            document.getElementById('editGermanInput').value = card.german;
            document.getElementById('editEnglishInput').value = card.english;
            document.getElementById('editExampleInput').value = card.example || '';

            document.getElementById('editModal').classList.add('visible');
            document.getElementById('editGermanInput').focus();
        }

        // Close edit modal
        function closeEditModal() {
            editingIndex = -1;
            document.getElementById('editModal').classList.remove('visible');
        }

        // Save edit
        function saveEdit() {
            if (editingIndex === -1) return;

            const german = document.getElementById('editGermanInput').value.trim();
            const english = document.getElementById('editEnglishInput').value.trim();
            const example = document.getElementById('editExampleInput').value.trim();

            if (!german || !english) {
                alert('Please enter both German and English words');
                return;
            }

            cards[editingIndex].german = german;
            cards[editingIndex].english = english;
            cards[editingIndex].example = example;

            saveCards();
            closeEditModal();
            updateDisplay();

            // Update study queue if in study mode
            if (studyMode && studyQueue[studyIndex]) {
                const card = cards[editingIndex];
                const queueCard = studyQueue[studyIndex];
                if (queueCard.german === card.german || queueCard.english === card.english) {
                    studyQueue[studyIndex] = { ...card };
                    updateStudyCard();
                }
            }
        }

        // Edit current card (from flashcard view)
        function editCurrentCard(event) {
            event.stopPropagation(); // Prevent card flip

            if (studyMode) {
                // Find the actual index in cards array
                const card = studyQueue[studyIndex];
                const index = cards.findIndex(c => c.german === card.german && c.english === card.english);
                if (index !== -1) {
                    openEditModal(index);
                }
            } else {
                openEditModal(currentIndex);
            }
        }

        // Settings modal functions
        function openSettingsModal() {
            document.getElementById('intervalWrong').value = settings.intervalWrong;
            document.getElementById('intervalCorrect').value = settings.intervalCorrect;
            document.getElementById('intervalEasy').value = settings.intervalEasy;

            // Set direction radio selection
            const directionOptions = document.querySelectorAll('.direction-option');
            directionOptions.forEach(option => {
                const direction = option.dataset.direction;
                const radio = option.querySelector('input[type="radio"]');
                if (direction === settings.studyDirection) {
                    option.classList.add('selected');
                    radio.checked = true;
                } else {
                    option.classList.remove('selected');
                    radio.checked = false;
                }
            });

            document.getElementById('settingsModal').classList.add('visible');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('visible');
        }

        function saveSettings() {
            const intervalWrong = parseInt(document.getElementById('intervalWrong').value) || 1;
            const intervalCorrect = parseInt(document.getElementById('intervalCorrect').value) || 3;
            const intervalEasy = parseInt(document.getElementById('intervalEasy').value) || 14;

            // Get selected direction
            const selectedDirection = document.querySelector('input[name="studyDirection"]:checked');
            const studyDirection = selectedDirection ? selectedDirection.value : 'de-en';

            settings.intervalWrong = Math.max(1, Math.min(365, intervalWrong));
            settings.intervalCorrect = Math.max(1, Math.min(365, intervalCorrect));
            settings.intervalEasy = Math.max(1, Math.min(365, intervalEasy));
            settings.studyDirection = studyDirection;

            saveSettingsToStorage();
            updateDirectionBadge();
            closeSettingsModal();

            // Update current display if not in study mode
            if (!studyMode && cards.length > 0) {
                updateFlashcard();
            }
        }

        // Update direction badge on home screen
        function updateDirectionBadge() {
            document.getElementById('directionBadgeText').textContent = getDirectionLabel(settings.studyDirection);
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (editingIndex !== -1) closeEditModal();
                if (document.getElementById('settingsModal').classList.contains('visible')) {
                    closeSettingsModal();
                }
            }
        });

        // Close modal when clicking overlay
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });

        // Direction option selection
        document.querySelectorAll('.direction-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.direction-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('input[type="radio"]').checked = false;
                });
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Enter key support for edit modal
        document.getElementById('editGermanInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('editEnglishInput').focus();
            }
        });

        document.getElementById('editEnglishInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('editExampleInput').focus();
            }
        });

        document.getElementById('editExampleInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveEdit();
            }
        });

        // Parse CSV content
        function parseCSV(text) {
            const lines = text.split(/\r?\n/);
            const results = [];

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Handle quoted fields with commas
                const fields = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        fields.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                fields.push(current.trim());

                if (fields.length >= 2 && fields[0] && fields[1]) {
                    results.push({
                        german: fields[0],
                        english: fields[1],
                        example: fields[2] || ''
                    });
                }
            }

            return results;
        }

        // Import CSV file
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const resultDiv = document.getElementById('importResult');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const parsed = parseCSV(text);

                    if (parsed.length === 0) {
                        resultDiv.textContent = 'No valid cards found in CSV. Format: German,English,Example (optional)';
                        resultDiv.className = 'import-result error';
                        resultDiv.style.display = 'block';
                        return;
                    }

                    // Add parsed cards
                    let added = 0;
                    for (const item of parsed) {
                        // Check for duplicates
                        const exists = cards.some(c =>
                            c.german.toLowerCase() === item.german.toLowerCase()
                        );

                        if (!exists) {
                            cards.push({
                                german: item.german,
                                english: item.english,
                                example: item.example || '',
                                level: 0,
                                nextReview: null,
                                lastReview: null
                            });
                            added++;
                        }
                    }

                    saveCards();
                    updateDisplay();

                    const skipped = parsed.length - added;
                    let message = `Imported ${added} card${added !== 1 ? 's' : ''}`;
                    if (skipped > 0) {
                        message += ` (${skipped} duplicate${skipped !== 1 ? 's' : ''} skipped)`;
                    }

                    resultDiv.textContent = message;
                    resultDiv.className = 'import-result success';
                    resultDiv.style.display = 'block';

                    // Reset file input
                    event.target.value = '';

                    // Hide message after 5 seconds
                    setTimeout(() => {
                        resultDiv.style.display = 'none';
                    }, 5000);

                } catch (err) {
                    resultDiv.textContent = 'Error reading CSV file: ' + err.message;
                    resultDiv.className = 'import-result error';
                    resultDiv.style.display = 'block';
                }
            };

            reader.readAsText(file);
        }

        // Export cards to CSV
        function exportCSV() {
            if (cards.length === 0) {
                alert('No cards to export');
                return;
            }

            // Build CSV content
            let csv = 'German,English,Example\n';

            for (const card of cards) {
                // Escape quotes and wrap in quotes if needed
                const german = card.german.includes(',') || card.german.includes('"')
                    ? '"' + card.german.replace(/"/g, '""') + '"'
                    : card.german;
                const english = card.english.includes(',') || card.english.includes('"')
                    ? '"' + card.english.replace(/"/g, '""') + '"'
                    : card.english;
                const example = (card.example || '').includes(',') || (card.example || '').includes('"')
                    ? '"' + (card.example || '').replace(/"/g, '""') + '"'
                    : (card.example || '');

                csv += `${german},${english},${example}\n`;
            }

            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'german-flashcards.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Update all displays
        function updateDisplay() {
            const flashcardSection = document.getElementById('flashcardSection');
            const emptyState = document.getElementById('emptyState');
            const navButtons = document.getElementById('navButtons');
            const reviewButtons = document.getElementById('reviewButtons');
            const flipHint = document.getElementById('flipHint');

            updateStudyStatus();

            if (cards.length === 0) {
                flashcardSection.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                flashcardSection.style.display = 'block';
                emptyState.style.display = 'none';
                navButtons.style.display = 'flex';
                reviewButtons.classList.remove('visible');
                flipHint.style.display = 'block';
                updateFlashcard();
            }

            updateCardList();
        }

        // Allow Enter key to navigate form fields and add cards
        document.getElementById('germanInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('englishInput').focus();
            }
        });

        document.getElementById('englishInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('exampleInput').focus();
            }
        });

        document.getElementById('exampleInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCard();
            }
        });

        // ============================================
        // SCAN WORD FEATURE
        // ============================================

        let scanStream = null;
        let tesseractWorker = null;

        // Open scan modal and start camera
        async function openScanModal() {
            const modal = document.getElementById('scanModal');
            modal.classList.add('visible');

            // Reset views
            showScanView('camera');

            // Start camera
            try {
                const video = document.getElementById('scanVideo');
                scanStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = scanStream;
            } catch (err) {
                console.error('Camera error:', err);
                showScanError('Could not access camera. Please ensure you have granted camera permissions.');
            }
        }

        // Close scan modal and stop camera
        function closeScanModal() {
            const modal = document.getElementById('scanModal');
            modal.classList.remove('visible');

            // Stop camera stream
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }

            // Reset video
            const video = document.getElementById('scanVideo');
            video.srcObject = null;
        }

        // Show different views in the scan modal
        function showScanView(view) {
            document.getElementById('cameraView').style.display = view === 'camera' ? 'block' : 'none';
            document.getElementById('processingView').style.display = view === 'processing' ? 'block' : 'none';
            document.getElementById('errorView').style.display = view === 'error' ? 'block' : 'none';
            document.getElementById('resultView').style.display = view === 'result' ? 'block' : 'none';
        }

        // Show error in scan modal
        function showScanError(message) {
            document.getElementById('scanError').textContent = message;
            showScanView('error');
        }

        // Capture image from video
        function captureImage() {
            const video = document.getElementById('scanVideo');
            const canvas = document.getElementById('scanCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0);

            // Get image data URL
            const imageDataUrl = canvas.toDataURL('image/png');

            // Show captured image in processing view
            document.getElementById('capturedImage').src = imageDataUrl;
            document.getElementById('resultImage').src = imageDataUrl;

            // Stop camera to save battery
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }

            // Start OCR processing
            showScanView('processing');
            processImage(imageDataUrl);
        }

        // Process image with OCR and translation
        async function processImage(imageDataUrl) {
            const statusText = document.getElementById('scanStatusText');
            const progressBar = document.getElementById('scanProgressBar');
            const progressContainer = document.getElementById('scanProgress');

            try {
                // Show progress bar
                progressContainer.style.display = 'block';
                statusText.textContent = 'Initializing OCR...';

                // Use Tesseract.js to recognize text
                const result = await Tesseract.recognize(
                    imageDataUrl,
                    'deu', // German language
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                progressBar.style.width = progress + '%';
                                statusText.textContent = `Recognizing text... ${progress}%`;
                            } else if (m.status === 'loading language traineddata') {
                                statusText.textContent = 'Loading German language data...';
                            }
                        }
                    }
                );

                // Get recognized text
                let recognizedText = result.data.text.trim();

                if (!recognizedText) {
                    showScanError('No text detected in the image. Please try again with clearer text.');
                    return;
                }

                // Clean up the text - get the first word or short phrase
                recognizedText = cleanupOcrText(recognizedText);

                statusText.textContent = 'Translating to English...';
                progressBar.style.width = '100%';

                // Translate to English
                const translation = await translateToEnglish(recognizedText);

                // Show results
                document.getElementById('scannedGerman').value = recognizedText;
                document.getElementById('scannedEnglish').value = translation;
                showScanView('result');

            } catch (err) {
                console.error('OCR/Translation error:', err);
                showScanError('Error processing image: ' + err.message);
            }
        }

        // Clean up OCR text - extract meaningful word/phrase
        function cleanupOcrText(text) {
            // Remove extra whitespace and newlines
            text = text.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();

            // If multiple words, try to get the most prominent one
            // For now, just take the first few words (up to 3)
            const words = text.split(' ').filter(w => w.length > 0);

            if (words.length > 3) {
                return words.slice(0, 3).join(' ');
            }

            return text;
        }

        // Translate German text to English using MyMemory API
        async function translateToEnglish(germanText) {
            try {
                const response = await fetch(
                    `https://api.mymemory.translated.net/get?q=${encodeURIComponent(germanText)}&langpair=de|en`
                );

                if (!response.ok) {
                    throw new Error('Translation service unavailable');
                }

                const data = await response.json();

                if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                } else {
                    // If translation fails, return empty string for manual entry
                    return '';
                }
            } catch (err) {
                console.error('Translation error:', err);
                // Return empty string so user can enter translation manually
                return '';
            }
        }

        // Retake photo - restart camera
        async function retakeScan() {
            showScanView('camera');

            // Restart camera
            try {
                const video = document.getElementById('scanVideo');
                scanStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                video.srcObject = scanStream;
            } catch (err) {
                console.error('Camera error:', err);
                showScanError('Could not access camera. Please ensure you have granted camera permissions.');
            }
        }

        // Save scanned card to flashcards
        function saveScannedCard() {
            const german = document.getElementById('scannedGerman').value.trim();
            const english = document.getElementById('scannedEnglish').value.trim();

            if (!german || !english) {
                alert('Please enter both German and English words');
                return;
            }

            // Check for duplicates
            const exists = cards.some(c =>
                c.german.toLowerCase() === german.toLowerCase()
            );

            if (exists) {
                if (!confirm('A card with this German word already exists. Add anyway?')) {
                    return;
                }
            }

            // Add the card
            cards.push({
                german,
                english,
                example: '',
                level: 0,
                nextReview: null,
                lastReview: null
            });

            saveCards();
            closeScanModal();
            currentIndex = cards.length - 1;
            updateDisplay();
        }

        // Close scan modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('scanModal').classList.contains('visible')) {
                closeScanModal();
            }
        });

        // Close scan modal when clicking overlay
        document.getElementById('scanModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeScanModal();
            }
        });

        // Initialize
        loadSettings();
        updateDirectionBadge();
        loadCards();

        // ============================================
        // PWA SERVICE WORKER REGISTRATION
        // ============================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('New version available! Refresh to update.');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
